# üõ°Ô∏è Raport reagowania na incydent web (IR-2025-12-10)

| Parametr | Warto≈õƒá |
| :--- | :--- |
| **Data incydentu** | 10 grudnia 2025 |
| **Ramy czasowe** | Pierwsze z≈Ço≈õliwe pr√≥by: ~20:45, Ostatnie: ~21:08 (czas serwera) |
| **Wykryty przez** | Wazuh SIEM Agent (`vps-ovh`) |
| **Typ ataku** | Zautomatyzowane skanowanie w poszukiwaniu luk (Vulnerability Scanning) |

---

### üåê ≈örodowisko
≈örodowisko Wazuh pe≈Çni rolƒô systemu bezpiecze≈Ñstwa w Homelabie, funkcjonujƒÖc jako platforma **SIEM/HIDS**. System ten monitoruje w czasie rzeczywistym ≈ÇƒÖcznie **9 agent√≥w**, z czego kluczowy **Agent #002 (`vps-ovh`)** jest zainstalowany na zewnƒôtrznym serwerze VPS. G≈Ç√≥wnym zadaniem Wazuh jest agregacja, analiza i alarmowanie o wszelkich nieprawid≈Çowo≈õciach w logach, co pozwala na szybkie wykrycie i reagowanie na pr√≥by atak√≥w.

![Dashboard Wazuh](/security-incidents/screenshots/agents_summary.png)


### üîç Wstƒôpna analiza

| Krok | Opis |
| :--- | :--- |
| **Wstƒôpna identyfikacja** | PoczƒÖtkowo logi z Agenta VPS (`vps-ovh`) pokazywa≈Çy adres IP `172.71.144.133`. |
| **Wnioskowanie** | Z uwagi na to, ≈ºe serwer stoi za Cloudflare, od razu by≈Ço jasne, ≈ºe jest to jeden z adres√≥w IP ich infrastruktury, a nie prawdziwy atakujƒÖcy. |
| **Cel ataku** | Szczeg√≥≈Çowa analiza zapyta≈Ñ URL w Wazuh wskazywa≈Ça na zautomatyzowane poszukiwanie luk (skanowanie) w plikach zwiƒÖzanych z popularnƒÖ wtyczkƒÖ **WooCommerce** (pr√≥by dostƒôpu do niestandardowych ≈õcie≈ºek `wp-content/plugins/...`). |

![Wazuh logs](/security-incidents/screenshots/wazuh_logs.png)

## üõ†Ô∏è Podjƒôte dzia≈Çania (Incident Response)

Celem by≈Ço zablokowanie ataku jak najszybciej i jak najdalej od serwera (Edge Security).

### 1. Identyfikacja prawdziwego ≈∫r√≥d≈Ça

Aby poznaƒá prawdziwy adres IP, **konieczna by≈Ça weryfikacja log√≥w po stronie Cloudflare**:

* **Weryfikacja w Cloudflare**: Po zalogowaniu siƒô do panelu Cloudflare (w sekcji `Security -> Analytics`) i filtrowaniu ruchu w odpowiednim zakresie czasu, **rzeczywisty adres IP atakujƒÖcego ustalono jako `146.70.178.246`**.

![Wazuh logs](/security-incidents/screenshots/cloudflare_requests.png)

### 2. Wdro≈ºenie blokady (skalowalno≈õƒá vs. plan darmowy)
Do zablokowania adresu IP u≈ºyto Cloudflare Firewall Rules.

- **Utworzenie listy IOC**: Na koncie Cloudflare (≈õrodowisko globalne: `Manage account -> Configurations -> Lists`) utworzono listƒô adres√≥w IP (np. `$block_ip`) zawierajƒÖcƒÖ zidentyfikowany adres `146.70.178.246`. **Jest to klucz do skalowalno≈õci ‚Äì zarzƒÖdzanie zagro≈ºeniem odbywa siƒô poprzez edycjƒô jednej listy.**
![Wazuh logs](/security-incidents/screenshots/list_ip.png)

- **Dodanie regu≈Ç firewall**: Z uwagi na pracƒô w darmowym planie Cloudflare, **konieczne by≈Ço dodanie regu≈Ç dla ka≈ºdej domeny** (w sekcji `domena -> Security -> Security Rules`):
    - **Nazwa regu≈Çy**: np. "Block IP"
    - **Expression**: `(ip.src in $block_ip)`
    - **Action**: Block

![Wazuh logs](/security-incidents/screenshots/security_rules.png)
- **Optymalizacja kolejno≈õci**: W przypadku domen, gdzie istnia≈Çy ju≈º inne regu≈Çy, **regu≈Çƒô blokujƒÖcƒÖ adres IP dodano najwy≈ºej**. Zapewniono to w celu potencjalnego zmniejszenia obciƒÖ≈ºenia serwera VPS, poniewa≈º ruch jest odrzucany natychmiast na krawƒôdzi sieci.

### 3. Udoskonalenie logowania (zwiƒôkszenie efektywno≈õci Wazuh)

Poniewa≈º w trakcie pierwszego incydentu system Wazuh pokaza≈Ç IP Cloudflare, a nie rzeczywiste, zaktualizowano konfiguracjƒô serwera Apache, aby w przysz≈Ço≈õci przyspieszyƒá identyfikacjƒô i reagowanie:

* **Modyfikacja pliku konfiguracyjnego**: Zmiany wprowadzono w pliku `/etc/apache2/apache2.conf` na serwerze VPS.
* **Implementacja RemoteIP**: Na samym ko≈Ñcu pliku dodano sekcjƒô konfiguracyjnƒÖ, kt√≥ra instruuje Apache, aby traktowa≈Ç nag≈Ç√≥wek `CF-Connecting-IP` (dostarczany przez Cloudflare) jako rzeczywisty adres ≈∫r√≥d≈Çowy:

```apache
# Cloudflare Real IP Configuration
RemoteIPHeader CF-Connecting-IP

RemoteIPTrustedProxy 173.245.48.0/20
RemoteIPTrustedProxy 103.21.244.0/22
RemoteIPTrustedProxy 103.22.200.0/22
RemoteIPTrustedProxy 103.31.4.0/22
RemoteIPTrustedProxy 141.101.64.0/18
RemoteIPTrustedProxy 108.162.192.0/18
RemoteIPTrustedProxy 190.93.240.0/20
RemoteIPTrustedProxy 188.114.96.0/20
RemoteIPTrustedProxy 197.234.240.0/22
RemoteIPTrustedProxy 198.41.128.0/17
RemoteIPTrustedProxy 162.158.0.0/15
RemoteIPTrustedProxy 104.16.0.0/13
RemoteIPTrustedProxy 104.24.0.0/14
RemoteIPTrustedProxy 172.64.0.0/13
RemoteIPTrustedProxy 131.0.72.0/22
RemoteIPTrustedProxy 2400:cb00::/32
RemoteIPTrustedProxy 2606:4700::/32
RemoteIPTrustedProxy 2803:f800::/32
RemoteIPTrustedProxy 2405:b500::/32
RemoteIPTrustedProxy 2405:8100::/32
RemoteIPTrustedProxy 2a06:98c0::/29
RemoteIPTrustedProxy 2c0f:f248::/32
```
* **Weryfikacja i Restart**: Po sprawdzeniu poprawno≈õci konfiguracji (`sudo apachectl configtest`) oraz restarcie systemu (`sudo systemctl restart apache2`), **rzeczywiste adresy IP sƒÖ widoczne w Wazuh**. W przysz≈Ço≈õci znacznie przyspieszy to identyfikacjƒô i blokadƒô adres√≥w, co jest kluczowe w procesie reagowania na incydenty.